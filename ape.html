<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Administrasi Penilaian dan Evaluasi</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        * { box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f9fbfd;
            color: #333;
        }
        .container {
            max-width: 800px;
            margin: auto;
            padding: 15px;
        }
        .back-btn {
            display: inline-block;
            margin: 10px 0;
            padding: 8px 15px;
            background: #7f8c8d;
            color: white;
            text-decoration: none;
            border-radius: 4px;
            font-size: 14px;
        }
        .back-btn:hover { background: #6c7b8b; }

        /* === NAVIGASI TAB === */
        .tabs {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin: 15px 0;
        }
        .tab-btn {
            flex: 1;
            min-width: 120px;
            padding: 12px;
            background: #ecf0f1;
            border: none;
            border-radius: 6px;
            font-weight: bold;
            cursor: pointer;
            text-align: center;
            font-size: 14px;
        }
        .tab-btn.active {
            background: #3498db;
            color: white;
        }

        /* === KONTEN FITUR === */
        .fitur-section {
            display: none;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            margin-top: 15px;
        }
        .fitur-section.active {
            display: block;
        }
        h2 {
            margin-top: 0;
            color: #2c3e50;
            border-bottom: 2px solid #3498db;
            padding-bottom: 6px;
        }
        .form-group {
            margin: 12px 0;
        }
        .form-group label {
            display: block;
            margin-bottom: 4px;
            font-weight: bold;
            font-size: 14px;
        }
        input, textarea, select {
            width: 100%;
            padding: 12px;
            font-size: 16px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        textarea { height: 100px; resize: vertical; }
        .btn {
            padding: 12px;
            width: 100%;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin: 8px 0;
        }
        .btn-simpan { background: #2ecc71; color: white; }
        .btn-edit { background: #f39c12; color: white; }
        .btn-hapus { background: #e74c3c; color: white; }

        /* === ENTRI DATA === */
        .entri-item {
            background: #f8f9fa;
            padding: 14px;
            margin: 12px 0;
            border-radius: 6px;
            border-left: 3px solid #3498db;
            font-size: 14px;
            position: relative;
        }
        .entri-actions {
            text-align: right;
            margin-top: 8px;
        }
        .entri-actions button {
            padding: 6px 10px;
            font-size: 12px;
            margin-left: 5px;
        }
    </style>
</head>
<body>

<div class="container">
    <a href="tatakelola139.html" class="back-btn">‚Üê Kembali ke Menu Utama</a>

    <h1 style="text-align:center; margin:10px 0;">Administrasi Penilaian dan Evaluasi</h1>

    <!-- NAVIGASI TAB -->
    <div class="tabs">
        <button class="tab-btn active" data-tab="3A">3A. Jurnal Refleksi</button>
        <button class="tab-btn" data-tab="3B">3B. Nilai Formatif</button>
        <button class="tab-btn" data-tab="3C">3C. Nilai Semester</button>
        <button class="tab-btn" data-tab="3D">3D. Laporan Pendidikan</button>
    </div>

    <!-- === 3A: JURNAL REFLEKSI === -->
    <div id="3A" class="fitur-section active">
        <h2>3A. Jurnal Refleksi</h2>
        <div class="form-group">
            <label>Tahun Pelajaran</label>
            <input type="text" id="jrTahun" placeholder="Contoh: 2025/2026" value="2025/2026">
        </div>
        <div class="form-group">
            <label>Tanggal</label>
            <input type="date" id="jrTanggal">
        </div>
        <div class="form-group">
            <label>Deskripsi Refleksi</label>
            <textarea id="jrRefleksi" placeholder="Ceritakan refleksi Anda hari ini..."></textarea>
        </div>
        <div class="form-group">
            <label>Keterangan</label>
            <input type="text" id="jrKeterangan" placeholder="Opsional">
        </div>
        <button class="btn btn-simpan" id="jrSimpan">‚úÖ Simpan Jurnal</button>
        <button class="btn btn-edit" id="jrEdit" style="display:none;">‚úèÔ∏è Update Jurnal</button>

        <h3>Daftar Entri Jurnal</h3>
        <div id="jrDaftar"><p>Memuat...</p></div>
    </div>

    <!-- === 3B: NILAI FORMATIF === -->
    <div id="3B" class="fitur-section">
        <h2>3B. Daftar Nilai Formatif</h2>
        <div class="form-group">
            <label>Nama Siswa</label>
            <input type="text" id="nfSiswa" placeholder="Nama siswa">
        </div>
        <div class="form-group">
            <label>Mata Pelajaran</label>
            <input type="text" id="nfMapel" placeholder="Mata pelajaran">
        </div>
        <div class="form-group">
            <label>Nilai</label>
            <input type="number" id="nfNilai" min="0" max="100" placeholder="Nilai (0‚Äì100)">
        </div>
        <div class="form-group">
            <label>Keterangan</label>
            <input type="text" id="nfKet" placeholder="Contoh: Kuis, Tugas, dll">
        </div>
        <button class="btn btn-simpan" id="nfSimpan">‚úÖ Simpan Nilai</button>
        <button class="btn btn-edit" id="nfEdit" style="display:none;">‚úèÔ∏è Update Nilai</button>

        <h3>Daftar Nilai Formatif</h3>
        <div id="nfDaftar"><p>Memuat...</p></div>
    </div>

    <!-- === 3C: NILAI SEMESTER === -->
    <div id="3C" class="fitur-section">
        <h2>3C. Daftar Nilai Semester</h2>
        <div class="form-group">
            <label>Nama Siswa</label>
            <input type="text" id="nsSiswa" placeholder="Nama siswa">
        </div>
        <div class="form-group">
            <label>Semester</label>
            <select id="nsSemester">
                <option value="Ganjil">Ganjil</option>
                <option value="Genap">Genap</option>
            </select>
        </div>
        <div class="form-group">
            <label>Tahun Pelajaran</label>
            <input type="text" id="nsTahun" placeholder="Contoh: 2025/2026" value="2025/2026">
        </div>
        <div class="form-group">
            <label>Nilai Akhir</label>
            <input type="number" id="nsNilai" min="0" max="100" placeholder="Nilai akhir semester">
        </div>
        <button class="btn btn-simpan" id="nsSimpan">‚úÖ Simpan Nilai Semester</button>
        <button class="btn btn-edit" id="nsEdit" style="display:none;">‚úèÔ∏è Update Nilai</button>

        <h3>Daftar Nilai Semester</h3>
        <div id="nsDaftar"><p>Memuat...</p></div>
    </div>

    <!-- === 3D: LAPORAN PENDIDIKAN (RAPOR) === -->
    <div id="3D" class="fitur-section">
        <h2>3D. Laporan Pendidikan (Rapor)</h2>
        <div class="form-group">
            <label>Nama Siswa</label>
            <input type="text" id="rpSiswa" placeholder="Nama siswa">
        </div>
        <div class="form-group">
            <label>Kelas</label>
            <input type="text" id="rpKelas" placeholder="Contoh: Kelas 5">
        </div>
        <div class="form-group">
            <label>Semester & Tahun Pelajaran</label>
            <input type="text" id="rpPeriode" placeholder="Contoh: Ganjil 2025/2026">
        </div>
        <div class="form-group">
            <label>Keterangan Umum (Deskripsi Sikap, Prestasi, dll)</label>
            <textarea id="rpDeskripsi" placeholder="Deskripsi rapor..."></textarea>
        </div>
        <button class="btn btn-simpan" id="rpSimpan">‚úÖ Simpan Laporan</button>
        <button class="btn btn-edit" id="rpEdit" style="display:none;">‚úèÔ∏è Update Laporan</button>

        <h3>Daftar Laporan Pendidikan</h3>
        <div id="rpDaftar"><p>Memuat...</p></div>
    </div>

    <!-- 3E‚Äì3G tetap sebagai teks statis di luar tab (opsional) -->
</div>

<script>
    // üîß Firebase
    const firebaseConfig = {
        apiKey: "AIzaSyD5stzd9mu0n58o_QYL5Jt1aXOP9ANQl80",
        authDomain: "sd139lamanda-d7e39.firebaseapp.com",
        databaseURL: "https://sd139lamanda-d7e39-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "sd139lamanda-d7e39",
        storageBucket: "sd139lamanda-d7e39.firebasestorage.app",
        messagingSenderId: "101544011485",
        appId: "1:101544011485:web:74c0fa59d3c4bf74451d34"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // Set tanggal hari ini
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('jrTanggal').value = today;

    // === NAVIGASI TAB ===
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            // Nonaktifkan semua
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.fitur-section').forEach(s => s.classList.remove('active'));
            // Aktifkan yang dipilih
            btn.classList.add('active');
            document.getElementById(btn.dataset.tab).classList.add('active');
        });
    });

    // === FUNGSI UMUM ===
    function showDaftar(refPath, containerId, renderItem) {
        const container = document.getElementById(containerId);
        db.ref(refPath).orderByChild('timestamp').on('value', (snapshot) => {
            container.innerHTML = '';
            const data = snapshot.val();
            if (!data) {
                container.innerHTML = '<p>Belum ada data.</p>';
                return;
            }
            const items = Object.entries(data)
                .map(([id, val]) => ({ id, ...val }))
                .sort((a, b) => b.timestamp - a.timestamp);
            items.forEach(item => {
                const div = document.createElement('div');
                div.className = 'entri-item';
                div.innerHTML = renderItem(item) + `
                    <div class="entri-actions">
                        <button class="btn-edit-small" onclick="editItem('${refPath}', '${item.id}', ${JSON.stringify(item).replace(/'/g, "\\'")})">Edit</button>
                        <button class="btn-hapus" onclick="hapusItem('${refPath}', '${item.id}')">Hapus</button>
                    </div>
                `;
                container.appendChild(div);
            });
        });
    }

    window.editItem = function(refPath, id, item) {
        if (refPath.includes('jurnalRefleksi')) {
            document.getElementById('jrTahun').value = item.tahunPelajaran || '';
            document.getElementById('jrTanggal').value = item.tanggalISO || '';
            document.getElementById('jrRefleksi').value = item.refleksi || '';
            document.getElementById('jrKeterangan').value = item.keterangan || '';
            window.currentEditId = { path: 'jurnalRefleksi', id };
            document.getElementById('jrSimpan').style.display = 'none';
            document.getElementById('jrEdit').style.display = 'block';
        } else if (refPath.includes('nilaiFormatif')) {
            document.getElementById('nfSiswa').value = item.namaSiswa || '';
            document.getElementById('nfMapel').value = item.mapel || '';
            document.getElementById('nfNilai').value = item.nilai || '';
            document.getElementById('nfKet').value = item.keterangan || '';
            window.currentEditId = { path: 'nilaiFormatif', id };
            document.getElementById('nfSimpan').style.display = 'none';
            document.getElementById('nfEdit').style.display = 'block';
        } else if (refPath.includes('nilaiSemester')) {
            document.getElementById('nsSiswa').value = item.namaSiswa || '';
            document.getElementById('nsSemester').value = item.semester || 'Ganjil';
            document.getElementById('nsTahun').value = item.tahunPelajaran || '';
            document.getElementById('nsNilai').value = item.nilai || '';
            window.currentEditId = { path: 'nilaiSemester', id };
            document.getElementById('nsSimpan').style.display = 'none';
            document.getElementById('nsEdit').style.display = 'block';
        } else if (refPath.includes('laporanPendidikan')) {
            document.getElementById('rpSiswa').value = item.namaSiswa || '';
            document.getElementById('rpKelas').value = item.kelas || '';
            document.getElementById('rpPeriode').value = item.periode || '';
            document.getElementById('rpDeskripsi').value = item.deskripsi || '';
            window.currentEditId = { path: 'laporanPendidikan', id };
            document.getElementById('rpSimpan').style.display = 'none';
            document.getElementById('rpEdit').style.display = 'block';
        }
    };

    window.hapusItem = function(refPath, id) {
        if (confirm('Yakin hapus data ini?')) {
            db.ref(refPath + '/' + id).remove()
                .then(() => alert('Data dihapus!'))
                .catch(err => alert('Gagal: ' + err.message));
        }
    };

    // === SIMPAN & EDIT LOGIC ===
    function setupForm(formId, path, getData, render) {
        const simpanBtn = document.getElementById(formId + 'Simpan');
        const editBtn = document.getElementById(formId + 'Edit');

        simpanBtn?.addEventListener('click', () => {
            const data = getData();
            if (!data) return;
            db.ref(path).push({ ...data, timestamp: firebase.database.ServerValue.TIMESTAMP })
                .then(() => {
                    // reset form
                    Object.values(document.querySelectorAll(`#${formId} input, #${formId} textarea, #${formId} select`))
                        .forEach(el => { if (el.type !== 'date') el.value = ''; });
                    alert('‚úÖ Data disimpan!');
                });
        });

        editBtn?.addEventListener('click', () => {
            const data = getData();
            if (!data || !window.currentEditId) return;
            db.ref(path + '/' + window.currentEditId.id).update(data)
                .then(() => {
                    editBtn.style.display = 'none';
                    simpanBtn.style.display = 'block';
                    delete window.currentEditId;
                    alert('‚úÖ Data diperbarui!');
                });
        });
    }

    // Setup semua form
    setupForm('jr', 'jurnalRefleksi', () => {
        const t = document.getElementById('jrTahun').value.trim();
        const d = document.getElementById('jrTanggal').value;
        const r = document.getElementById('jrRefleksi').value.trim();
        const k = document.getElementById('jrKeterangan').value.trim();
        if (!t || !d || !r) { alert('Isi semua kolom wajib!'); return null; }
        const hariList = ["Minggu","Senin","Selasa","Rabu","Kamis","Jumat","Sabtu"];
        const dt = new Date(d);
        return {
            tahunPelajaran: t,
            tanggalISO: d,
            hari: hariList[dt.getDay()],
            tanggalIndo: dt.toLocaleDateString('id-ID'),
            refleksi: r,
            keterangan: k || '-'
        };
    }, (item) => `
        <div><strong>${item.hari}, ${item.tanggalIndo}</strong> (${item.tahunPelajaran})</div>
        <div>${item.refleksi}</div>
        <div><em>Ket: ${item.keterangan}</em></div>
    `);

    setupForm('nf', 'nilaiFormatif', () => {
        const s = document.getElementById('nfSiswa').value.trim();
        const m = document.getElementById('nfMapel').value.trim();
        const n = document.getElementById('nfNilai').value;
        const k = document.getElementById('nfKet').value.trim();
        if (!s || !m || !n) { alert('Isi semua kolom wajib!'); return null; }
        return { namaSiswa: s, mapel: m, nilai: parseInt(n), keterangan: k || '-' };
    }, (item) => `${item.namaSiswa} | ${item.mapel} | Nilai: ${item.nilai} | ${item.keterangan}`);

    setupForm('ns', 'nilaiSemester', () => {
        const s = document.getElementById('nsSiswa').value.trim();
        const sem = document.getElementById('nsSemester').value;
        const t = document.getElementById('nsTahun').value.trim();
        const n = document.getElementById('nsNilai').value;
        if (!s || !sem || !t || !n) { alert('Isi semua kolom!'); return null; }
        return { namaSiswa: s, semester: sem, tahunPelajaran: t, nilai: parseInt(n) };
    }, (item) => `${item.namaSiswa} | ${item.semester} ${item.tahunPelajaran} | Nilai: ${item.nilai}`);

    setupForm('rp', 'laporanPendidikan', () => {
        const s = document.getElementById('rpSiswa').value.trim();
        const k = document.getElementById('rpKelas').value.trim();
        const p = document.getElementById('rpPeriode').value.trim();
        const d = document.getElementById('rpDeskripsi').value.trim();
        if (!s || !k || !p || !d) { alert('Isi semua kolom!'); return null; }
        return { namaSiswa: s, kelas: k, periode: p, deskripsi: d };
    }, (item) => `
        <div><strong>${item.namaSiswa} - ${item.kelas}</strong></div>
        <div><em>${item.periode}</em></div>
        <div>${item.deskripsi}</div>
    `);

    // Tampilkan daftar real-time
    showDaftar('jurnalRefleksi', 'jrDaftar', (item) => `
        <div><strong>${item.hari}, ${item.tanggalIndo}</strong> (${item.tahunPelajaran})</div>
        <div>${item.refleksi}</div>
        <div><em>Ket: ${item.keterangan}</em></div>
    `);
    showDaftar('nilaiFormatif', 'nfDaftar', (item) => `${item.namaSiswa} | ${item.mapel} | Nilai: ${item.nilai} | ${item.keterangan}`);
    showDaftar('nilaiSemester', 'nsDaftar', (item) => `${item.namaSiswa} | ${item.semester} ${item.tahunPelajaran} | Nilai: ${item.nilai}`);
    showDaftar('laporanPendidikan', 'rpDaftar', (item) => `
        <div><strong>${item.namaSiswa} - ${item.kelas}</strong></div>
        <div><em>${item.periode}</em></div>
        <div>${item.deskripsi}</div>
    `);
</script>

</body>
</html>
