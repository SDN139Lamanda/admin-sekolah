<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Administrasi Management Kelas</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-database-compat.js"></script>

    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f0f8ff;
        }
        .container {
            max-width: 800px;
            margin: auto;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            text-align: center;
            color: #2c3e50;
        }
        .back-btn {
            position: fixed;
            top: 10px;
            left: 10px;
            padding: 10px 15px;
            background-color: #7f8c8d;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            text-decoration: none;
        }
        .back-btn:hover {
            background-color: #6c7b8b;
        }
        .section {
            margin-bottom: 25px;
        }
        h2 {
            color: #34495e;
            border-bottom: 2px solid #3498db;
            padding-bottom: 5px;
        }
        ul {
            padding-left: 20px;
        }
        li {
            margin-bottom: 10px;
            line-height: 1.5;
        }
        .sub-feature-btn {
            display: block;
            width: 100%;
            padding: 12px;
            margin-bottom: 10px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            text-align: left;
            font-size: 14px;
        }
        .sub-feature-btn:hover {
            background-color: #2980b9;
        }

        #formTambahSiswa,
        #formAbsensi,
        #absensiTabelSection {
            display: none;
        }

        .form-input {
            margin-top: 15px;
        }
        .form-input label {
            display: block;
            margin: 10px 0 5px;
            font-weight: bold;
            color: #2c3e50;
        }
        .form-input input[type="text"],
        .form-input input[type="number"],
        .form-input select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 14px;
            box-sizing: border-box;
        }
        .form-input button {
            margin-top: 15px;
            padding: 10px 20px;
            background-color: #27ae60;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        .form-input button:hover {
            background-color: #219653;
        }
        .form-input button:disabled {
            background-color: #bdc3c7;
            cursor: not-allowed;
        }

        #notification,
        #notificationAbsensi {
            margin-top: 15px;
            padding: 10px;
            border-radius: 4px;
            display: none;
        }
        .success { background-color: #d4edda; color: #155724; }
        .error { background-color: #f8d7da; color: #721c24; }

        .attendance-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        .attendance-table th,
        .attendance-table td {
            border: 1px solid #ccc;
            padding: 6px;
            text-align: center;
            font-size: 12px;
        }
        .attendance-table th {
            background-color: #f0f8ff;
        }
        .date-cell {
            width: 30px;
            height: 30px;
            cursor: pointer;
        }
        .date-cell:hover {
            background-color: #e0f7fa;
        }
        .status-s { background-color: #fff9c4; }
        .status-i { background-color: #bbdefb; }
        .status-a { background-color: #ffcdd2; }
        .weekend-cell {
            background-color: #fee2e2;
            color: #ef4444;
            font-weight: bold;
        }
    </style>
</head>
<body>

    <a href="tatakelola139.html" class="back-btn">‚Üê Kembali ke Menu Utama</a>

    <div class="container">
        <h1>Administrasi Management Kelas</h1>

        <div class="section">
            <h2>Daftar Sub-Fitur</h2>
            <ul>
                <li><button class="sub-feature-btn" onclick="tampilkanFormTambahSiswa()">2A. Tambah Siswa</button></li>
                <li><button class="sub-feature-btn" onclick="tampilkanFormAbsensi()">2B. Absensi Kelas</button></li>
                <li><strong>2C.</strong> Jurnal Peristiwa (Placeholder)</li>
            </ul>
        </div>

        <!-- Form 2A -->
        <div class="section" id="formTambahSiswa">
            <h2>2A. Tambah Siswa</h2>
            <div class="form-input">
                <label for="namaSiswa">Nama Siswa:</label>
                <input type="text" id="namaSiswa" placeholder="Contoh: Budi Santoso" maxlength="100">
                <label for="jenisKelamin">Jenis Kelamin:</label>
                <select id="jenisKelamin">
                    <option value="">-- Pilih --</option>
                    <option value="L">Laki-laki</option>
                    <option value="P">Perempuan</option>
                </select>
                <button onclick="tambahSiswa()">Simpan Siswa</button>
                <div id="notification"></div>
            </div>
        </div>

        <!-- Form 2B -->
        <div class="section" id="formAbsensi">
            <h2>2B. Absensi Kelas</h2>
            <div class="form-input">
                <label for="bulanAbsen">Bulan:</label>
                <select id="bulanAbsen">
                    <option value="01">Januari</option>
                    <option value="02">Februari</option>
                    <option value="03">Maret</option>
                    <option value="04">April</option>
                    <option value="05">Mei</option>
                    <option value="06">Juni</option>
                    <option value="07" selected>Juli</option>
                    <option value="08">Agustus</option>
                    <option value="09">September</option>
                    <option value="10">Oktober</option>
                    <option value="11">November</option>
                    <option value="12">Desember</option>
                </select>
                <label for="tahunAbsen">Tahun:</label>
                <input type="number" id="tahunAbsen" value="2024" min="2020" max="2030">
                <div style="margin-top: 15px;">
                    <button onclick="muatAbsensi()">Muat Absensi</button>
                    <button onclick="simpanAbsensi()" style="background-color: #27ae60;">üíæ Simpan</button>
                    <button onclick="toggleEditMode()" id="editBtn">‚úèÔ∏è Edit</button>
                    <button onclick="tampilkanFormTambahSiswa()" style="background-color: #8e44ad;">+ Siswa</button>
                </div>
                <div id="notificationAbsensi"></div>
            </div>

            <div id="absensiTabelSection">
                <h3 style="margin-top: 20px;">Daftar Hadir Siswa ‚Äì <span id="bulanTahunTampil">Juli 2024</span></h3>
                <div style="overflow-x: auto;">
                    <table class="attendance-table" id="tabelAbsen"></table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // === FIREBASE ===
        const firebaseConfig = {
            apiKey: "AIzaSyD5stzd9mu0n58o_QYL5Jt1aXOP9ANQl80",
            authDomain: "sd139lamanda-d7e39.firebaseapp.com",
            databaseURL: "https://sd139lamanda-d7e39-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "sd139lamanda-d7e39",
            storageBucket: "sd139lamanda-d7e39.firebasestorage.app",
            messagingSenderId: "101544011485",
            appId: "1:101544011485:web:74c0fa59d3c4bf74451d34"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let daftarSiswa = [];
        let dataAbsensi = {};
        let sedangEdit = false;
        const KELAS_PATH = "kelas/4/siswa";

        // === 2A: TAMBAH SISWA ===
        function tambahSiswa() {
            const nama = document.getElementById('namaSiswa').value.trim();
            const jk = document.getElementById('jenisKelamin').value;
            if (!nama || !jk) {
                showNotif("Nama dan jenis kelamin wajib diisi.", "error", "notification");
                return;
            }

            const dataSiswa = { name: nama, gender: jk };
            const btn = document.querySelector('#formTambahSiswa button');
            const originalText = btn.textContent;
            btn.disabled = true;
            btn.textContent = "Menyimpan...";

            db.ref(KELAS_PATH).push(dataSiswa)
                .then(() => {
                    showNotif("Siswa berhasil ditambahkan.", "success", "notification");
                    document.getElementById('namaSiswa').value = '';
                    document.getElementById('jenisKelamin').value = '';
                    if (!document.getElementById('absensiTabelSection').style.display.includes('none')) {
                        muatDaftarSiswa().then(muatAbsensi);
                    }
                    btn.disabled = false;
                    btn.textContent = originalText;
                })
                .catch(err => {
                    showNotif("Gagal: " + err.message, "error", "notification");
                    btn.disabled = false;
                    btn.textContent = originalText;
                });
        }

        // === 2B: MUAT DATA ===
        async function muatDaftarSiswa() {
            const snap = await db.ref(KELAS_PATH).once('value');
            daftarSiswa = [];
            snap.forEach(child => {
                daftarSiswa.push({ key: child.key, ...child.val() });
            });
            daftarSiswa.sort((a, b) => a.name.localeCompare(b.name));
        }

        async function muatAbsensi() {
            await muatDaftarSiswa();
            const bulan = document.getElementById('bulanAbsen').value;
            const tahun = document.getElementById('tahunAbsen').value;
            const path = `absensi/kelas4/2024-2025/ganjil/${tahun}-${bulan}`;
            const snap = await db.ref(path).once('value');
            dataAbsensi = snap.val() || {};

            const namaBulan = ["Januari","Februari","Maret","April","Mei","Juni","Juli","Agustus","September","Oktober","November","Desember"];
            document.getElementById('bulanTahunTampil').textContent = `${namaBulan[parseInt(bulan)-1]} ${tahun}`;
            buatTabelAbsensi();
            document.getElementById('absensiTabelSection').style.display = 'block';
        }

        function tampilkanFormAbsensi() {
            document.getElementById('formAbsensi').style.display = 'block';
            document.getElementById('formAbsensi').scrollIntoView({ behavior: 'smooth' });
        }
        function tampilkanFormTambahSiswa() {
            document.getElementById('formTambahSiswa').style.display = 'block';
        }

        // === TABEL ABSENSI: KOSONG SECARA DEFAULT ===
        function buatTabelAbsensi() {
            const bulan = document.getElementById('bulanAbsen').value;
            const tahun = document.getElementById('tahunAbsen').value;
            const hariDalamBulan = new Date(tahun, bulan, 0).getDate();

            let html = `<thead><tr><th>No</th><th>Nama</th><th>L/P</th>`;
            for (let d = 1; d <= hariDalamBulan; d++) html += `<th>${d}</th>`;
            html += `<th>H</th><th>S</th><th>I</th><th>A</th></tr></thead><tbody>`;

            daftarSiswa.forEach((siswa, idx) => {
                const absen = dataAbsensi[siswa.key] || {};
                html += `<tr><td>${idx+1}</td><td>${siswa.name}</td><td>${siswa.gender}</td>`;
                for (let d = 1; d <= hariDalamBulan; d++) {
                    const status = absen[d] || '';
                    const kelas = getStatusClass(tahun, bulan, d);
                    html += `<td class="date-cell ${kelas}" data-key="${siswa.key}" data-hari="${d}">${status}</td>`;
                }

                // Hitung H = hari aktif - (S+I+A)
                let totalHariAktif = 0;
                let s = 0, i = 0, a = 0;
                for (let d = 1; d <= hariDalamBulan; d++) {
                    const date = new Date(tahun, bulan - 1, d);
                    if (date.getDay() % 6 !== 0) totalHariAktif++; // bukan Sabtu/Minggu
                }
                for (let d = 1; d <= hariDalamBulan; d++) {
                    const st = absen[d] || '';
                    if (st === 'S') s++;
                    else if (st === 'I') i++;
                    else if (st === 'A') a++;
                }
                const h = totalHariAktif - (s + i + a);
                html += `<td>${h >= 0 ? h : 0}</td><td>${s}</td><td>${i}</td><td>${a}</td></tr>`;
            });
            html += `</tbody>`;
            document.getElementById('tabelAbsen').innerHTML = html;

            if (sedangEdit) {
                document.querySelectorAll('.date-cell').forEach(cell => {
                    cell.onclick = () => gantiStatus(cell);
                });
            }
        }

        function getStatusClass(tahun, bulan, hari) {
            let kelas = '';
            const date = new Date(tahun, bulan-1, hari);
            if ([0,6].includes(date.getDay())) kelas = 'weekend-cell';
            return kelas;
        }

        function gantiStatus(cell) {
            const key = cell.dataset.key;
            const hari = cell.dataset.hari;
            const sekarang = cell.textContent.trim();

            let berikutnya = '';
            if (sekarang === '') berikutnya = 'S';
            else if (sekarang === 'S') berikutnya = 'I';
            else if (sekarang === 'I') berikutnya = 'A';
            else if (sekarang === 'A') berikutnya = '';

            cell.textContent = berikutnya;
            cell.className = 'date-cell ' + getStatusClass(document.getElementById('tahunAbsen').value, document.getElementById('bulanAbsen').value, hari);
            if (berikutnya === 'S') cell.className += ' status-s';
            else if (berikutnya === 'I') cell.className += ' status-i';
            else if (berikutnya === 'A') cell.className += ' status-a';

            if (!dataAbsensi[key]) dataAbsensi[key] = {};
            if (berikutnya === '') delete dataAbsensi[key][hari];
            else dataAbsensi[key][hari] = berikutnya;
        }

        function toggleEditMode() {
            sedangEdit = !sedangEdit;
            document.getElementById('editBtn').textContent = sedangEdit ? 'üîí Selesai' : '‚úèÔ∏è Edit';
            buatTabelAbsensi();
        }

        function simpanAbsensi() {
            const bulan = document.getElementById('bulanAbsen').value;
            const tahun = document.getElementById('tahunAbsen').value;
            const path = `absensi/kelas4/2024-2025/ganjil/${tahun}-${bulan}`;
            db.ref(path).set(dataAbsensi)
                .then(() => showNotif("Absensi berhasil disimpan.", "success", "notificationAbsensi"))
                .catch(err => showNotif("Gagal: " + err.message, "error", "notificationAbsensi"));
        }

        function showNotif(pesan, tipe, id) {
            const el = document.getElementById(id);
            el.textContent = pesan;
            el.className = tipe;
            el.style.display = 'block';
            setTimeout(() => el.style.display = 'none', 4000);
        }
    </script>
</body>
</html>
